<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.solvd.atm.persistence.AccountRepository">

    <update id="blockAccount">
        <include refid="setLock"/>
    </update>

    <sql id="setLock">
        update Account a join Card c
        on c.account_id = a.id
        set a.lock = true
        where c.card_number = #{card.number}
    </sql>

    <select id="getAccountInfo" resultMap="AccountInfoResultMap">
        Select
        <include refid="getInfoBody"/>
        From
        <include refid="getInfoJoins"/>
        Where
        <include refid="getInfoFilters"/>
    </select>

    <sql id="getInfoBody">
        a.money as account_money, a.number as account_number, c.pin as card_pin
    </sql>
    <sql id="getInfoJoins">
        account a left join card c
        on a.id = c.account_id
    </sql>
    <sql id="getInfoFilters">
        card_number = #{card.number}
    </sql>

    <update id="decrementAccountMoney">
        <include refid="setMoney"/>
    </update>

    <sql id="setMoney">
    update Account a
    set money = money - #{money}
    where a.number = #{account.number}
    </sql>

    <update id="unblockAccount">
        <include refid="setUnlock"/>
    </update>

    <sql id="setUnlock">
        update Account a join Card c
        on c.account_id = a.id
        set a.lock = false
        where c.card_number = #{card.cardNumber}
    </sql>

    <resultMap id="AccountInfoResultMap" type="Account" autoMapping="false">
        <id property="id" column="account_id"/>
        <result property="money" column="account_money"/>
        <result property="number" column="account_number"/>
        <collection property="cardsList" columnPrefix="account_"
                    resultMap="com.solvd.atm.persistence.CardRepository.CardResultMap"/>
    </resultMap>
</mapper>